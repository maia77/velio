#!/bin/bash

# ุณูุฑูุจุช ุชุดุบูู ุงูุชุทุจููุงุช ูุน ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ
echo "๐ ุจุฏุก ุชุดุบูู ุงูุชุทุจููุงุช ูุน ุงููุฒุงููุฉ ุงูุชููุงุฆูุฉ ููุตูุฑ"
echo "=================================================="

# ุฅููุงู ุฃู ุนูููุงุช ุณุงุจูุฉ
echo "โน๏ธ  ุฅููุงู ุงูุนูููุงุช ุงูุณุงุจูุฉ..."
pkill -f "python.*app.py" 2>/dev/null || true
pkill -f "watch_images.py" 2>/dev/null || true
lsof -ti:5003 | xargs kill -9 2>/dev/null || true
lsof -ti:5007 | xargs kill -9 2>/dev/null || true

# ูุฒุงููุฉ ุงูุตูุฑ ูุจู ุงูุจุฏุก
echo "๐ ูุฒุงููุฉ ุงูุตูุฑ ูุจู ุงูุจุฏุก..."
python3 auto_sync_images.py

# ุจุฏุก ูุฑุงูุจ ุงูุตูุฑ ูู ุงูุฎูููุฉ
echo "๐๏ธ  ุจุฏุก ูุฑุงูุจ ุงูุตูุฑ ุงูุชููุงุฆู..."
python3 watch_images.py &
WATCH_PID=$!

# ุงูุชุธุงุฑ ูููู
sleep 2

# ุจุฏุก ุงูุชุทุจูู ุงูุฑุฆูุณู (web)
echo "๐ ุจุฏุก ุงูุชุทุจูู ุงูุฑุฆูุณู ุนูู ุงููููุฐ 5003..."
cd web
python3 app.py &
WEB_PID=$!

# ุงูุนูุฏุฉ ูููุฌูุฏ ุงูุฑุฆูุณู
cd ..

# ุงูุชุธุงุฑ ูููู
sleep 3

# ุจุฏุก ุชุทุจูู ุงูุฅุฏุงุฑุฉ
echo "โ๏ธ  ุจุฏุก ุชุทุจูู ุงูุฅุฏุงุฑุฉ ุนูู ุงููููุฐ 5007..."
cd admin-app
python3 admin_app_fixed.py &
ADMIN_PID=$!

# ุงูุนูุฏุฉ ูููุฌูุฏ ุงูุฑุฆูุณู
cd ..

# ุงูุชุธุงุฑ ูููู ููุชุฃูุฏ ูู ุจุฏุก ุงูุชุทุจููุงุช
sleep 5

echo ""
echo "โ ุชู ุชุดุบูู ุฌููุน ุงูุชุทุจููุงุช ุจูุฌุงุญ!"
echo "=================================="
echo "๐ ุงูุชุทุจูู ุงูุฑุฆูุณู: http://127.0.0.1:5003"
echo "โ๏ธ  ุชุทุจูู ุงูุฅุฏุงุฑุฉ: http://127.0.0.1:5007"
echo "๐๏ธ  ูุฑุงูุจ ุงูุตูุฑ: ูุนูู ูู ุงูุฎูููุฉ"
echo ""
echo "๐ฑ ูููุตูู ูู ุงููุงุชู:"
echo "๐ ุงูุชุทุจูู ุงูุฑุฆูุณู: http://192.168.0.72:5003"
echo "โ๏ธ  ุชุทุจูู ุงูุฅุฏุงุฑุฉ: http://192.168.0.72:5007"
echo ""
echo "โน๏ธ  ููุฅููุงู: ุงุถุบุท Ctrl+C"

# ุฏุงูุฉ ุงูุชูุธูู ุนูุฏ ุงูุฅููุงู
cleanup() {
    echo ""
    echo "โน๏ธ  ุฅููุงู ุฌููุน ุงูุชุทุจููุงุช..."
    kill $WEB_PID 2>/dev/null || true
    kill $ADMIN_PID 2>/dev/null || true
    kill $WATCH_PID 2>/dev/null || true
    pkill -f "python.*app.py" 2>/dev/null || true
    pkill -f "watch_images.py" 2>/dev/null || true
    echo "โ ุชู ุฅููุงู ุฌููุน ุงูุชุทุจููุงุช"
    exit 0
}

# ุฑุจุท ุฏุงูุฉ ุงูุชูุธูู ุจุฅุดุงุฑุฉ ุงูุฅููุงู
trap cleanup SIGINT SIGTERM

# ุงูุชุธุงุฑ ุฅูู ูุง ูุง ููุงูุฉ
while true; do
    sleep 1
done
