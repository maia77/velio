#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ุณูุฑูุจุช ูุฅุตูุงุญ ูุดุงูู ุงูุชุนูููุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช
"""

import sys
import os

# ุฅุถุงูุฉ ูุณุงุฑ ุงูุชุทุจูู
sys.path.append(os.path.dirname(__file__))

from app import app, db
from models import Comment, Product, ProductImage, Order, OrderStatusHistory

def fix_comments_database():
    """ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุชุนูููุงุช"""
    try:
        print("๐ง ุจุฏุก ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ููุชุนูููุงุช...")
        print("=" * 50)
        
        with app.app_context():
            # ุฅูุดุงุก ุฌููุน ุงูุฌุฏุงูู
            print("๐ ุฅูุดุงุก ุงูุฌุฏุงูู...")
            db.create_all()
            
            # ุงูุชุญูู ูู ูุฌูุฏ ุฌุฏูู ุงูุชุนูููุงุช
            print("๐ ุงูุชุญูู ูู ุฌุฏูู ุงูุชุนูููุงุช...")
            
            # ูุญุงููุฉ ุงูุงุณุชุนูุงู ุนู ุฌุฏูู ุงูุชุนูููุงุช
            try:
                comments = Comment.query.limit(1).all()
                print("โ ุฌุฏูู ุงูุชุนูููุงุช ููุฌูุฏ ููุนูู ุจุดูู ุตุญูุญ")
            except Exception as e:
                print(f"โ ูุดููุฉ ูู ุฌุฏูู ุงูุชุนูููุงุช: {e}")
                return False
            
            # ุงูุชุญูู ูู ูุฌูุฏ ุนููุฏ image_url
            print("๐ผ๏ธ ุงูุชุญูู ูู ุนููุฏ image_url...")
            try:
                # ูุญุงููุฉ ุฅูุดุงุก ุชุนููู ุชุฌุฑูุจู ููุชุญูู ูู ุงูุฃุนูุฏุฉ
                test_comment = Comment(
                    product_id=1,
                    name="ุงุฎุชุจุงุฑ",
                    content="ุชุนููู ุชุฌุฑูุจู",
                    image_url=None
                )
                # ูุง ูุญูุธ ุงูุชุนูููุ ููุท ูุชุญูู ูู ุตุญุฉ ุงูุจูุงูุงุช
                print("โ ุนููุฏ image_url ููุฌูุฏ ููุนูู ุจุดูู ุตุญูุญ")
            except Exception as e:
                print(f"โ ูุดููุฉ ูู ุนููุฏ image_url: {e}")
                return False
            
            # ุงูุชุญูู ูู ูุฌูุฏ ููุชุฌุงุช
            print("๐ฆ ุงูุชุญูู ูู ุงูููุชุฌุงุช...")
            products = Product.query.limit(1).all()
            if products:
                print(f"โ ููุฌุฏ {Product.query.count()} ููุชุฌ ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช")
            else:
                print("โ๏ธ ูุง ุชูุฌุฏ ููุชุฌุงุช ูู ูุงุนุฏุฉ ุงูุจูุงูุงุช")
            
            print("=" * 50)
            print("โ ุชู ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ุจูุฌุงุญ!")
            print("๐ ุงูุชุนูููุงุช ุฌุงูุฒุฉ ููุงุณุชุฎุฏุงู")
            
            return True
            
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช: {e}")
        return False

def test_comments_api():
    """ุงุฎุชุจุงุฑ API ุงูุชุนูููุงุช"""
    try:
        print("\n๐งช ุงุฎุชุจุงุฑ API ุงูุชุนูููุงุช...")
        print("=" * 30)
        
        with app.app_context():
            # ุงุฎุชุจุงุฑ ุฅูุดุงุก ุชุนููู
            print("๐ ุงุฎุชุจุงุฑ ุฅูุดุงุก ุชุนููู...")
            
            # ุงูุจุญุซ ุนู ููุชุฌ ููุฌูุฏ
            product = Product.query.first()
            if not product:
                print("โ ูุง ุชูุฌุฏ ููุชุฌุงุช ูุงุฎุชุจุงุฑ ุงูุชุนูููุงุช")
                return False
            
            # ุฅูุดุงุก ุชุนููู ุชุฌุฑูุจู
            test_comment = Comment(
                product_id=product.id,
                name="ูุณุชุฎุฏู ุชุฌุฑูุจู",
                content="ูุฐุง ุชุนููู ุชุฌุฑูุจู ูุงุฎุชุจุงุฑ ุงููุธุงู",
                rating=5,
                image_url=None
            )
            
            db.session.add(test_comment)
            db.session.commit()
            
            print(f"โ ุชู ุฅูุดุงุก ุชุนููู ุชุฌุฑูุจู ููููุชุฌ {product.id}")
            
            # ุงุฎุชุจุงุฑ ุฌูุจ ุงูุชุนูููุงุช
            print("๐ ุงุฎุชุจุงุฑ ุฌูุจ ุงูุชุนูููุงุช...")
            comments = Comment.query.filter_by(product_id=product.id).all()
            print(f"โ ุชู ุงูุนุซูุฑ ุนูู {len(comments)} ุชุนููู ููููุชุฌ")
            
            # ุญุฐู ุงูุชุนููู ุงูุชุฌุฑูุจู
            db.session.delete(test_comment)
            db.session.commit()
            print("๐๏ธ ุชู ุญุฐู ุงูุชุนููู ุงูุชุฌุฑูุจู")
            
            print("โ ุฌููุน ุงุฎุชุจุงุฑุงุช API ุงูุชุนูููุงุช ูุฌุญุช!")
            return True
            
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุงุฎุชุจุงุฑ API ุงูุชุนูููุงุช: {e}")
        return False

def main():
    """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ"""
    print("๐ ุจุฏุก ุฅุตูุงุญ ูุดุงูู ุงูุชุนูููุงุช...")
    print("=" * 60)
    
    # ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช
    db_success = fix_comments_database()
    
    if db_success:
        # ุงุฎุชุจุงุฑ API
        api_success = test_comments_api()
        
        print("\n" + "=" * 60)
        if api_success:
            print("๐ ุชู ุฅุตูุงุญ ุฌููุน ูุดุงูู ุงูุชุนูููุงุช ุจูุฌุงุญ!")
            print("โจ ูููู ุงูุขู:")
            print("   - ุฅุถุงูุฉ ุชุนูููุงุช ุฌุฏูุฏุฉ")
            print("   - ุฑูุน ุตูุฑ ูุน ุงูุชุนูููุงุช")
            print("   - ุนุฑุถ ุงูุชุนูููุงุช ูู ุตูุญุงุช ุงูููุชุฌุงุช")
        else:
            print("โ๏ธ ุชู ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช ูููู ููุงู ูุดุงูู ูู API")
    else:
        print("โ ูุดู ูู ุฅุตูุงุญ ูุงุนุฏุฉ ุงูุจูุงูุงุช")
        print("๐ก ุชุฃูุฏ ูู ุฅุนุฏุงุฏุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช")

if __name__ == "__main__":
    main()
