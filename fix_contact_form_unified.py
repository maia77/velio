#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
๐ง ุฅุตูุงุญ ูุดููุฉ ูููุฐุฌ "ุงุชุตู ุจูุง" - ุฅุนุฏุงุฏ ููุญุฏ ููุทูุจุงุช ูุงูุชูุงุตู
ูุฐุง ุงูุณูุฑูุจุช ูุนุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุฎุฏูุฉ ุงูุทูุจุงุช ููููุฐุฌ "ุงุชุตู ุจูุง" ูุนุงู
"""

import os
import sys
from pathlib import Path

def print_header():
    print("=" * 70)
    print("๐ง ุฅุตูุงุญ ูุดููุฉ ูููุฐุฌ 'ุงุชุตู ุจูุง' - ุฅุนุฏุงุฏ ููุญุฏ")
    print("๐ง ููุณ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุทูุจุงุช ูุงูุชูุงุตู")
    print("=" * 70)
    print()

def check_current_config():
    """ูุญุต ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ"""
    print("๐ ูุญุต ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ...")
    
    env_file = Path('.env')
    if not env_file.exists():
        print("โ ููู .env ุบูุฑ ููุฌูุฏ!")
        return False
    
    with open('.env', 'r', encoding='utf-8') as f:
        content = f.read()
    
    if 'your-email@yahoo.com' in content or 'your-app-password' in content:
        print("โ ุงูุฅุนุฏุงุฏุงุช ุชุญุชูู ุนูู ููู ุงูุชุฑุงุถูุฉ")
        print("   SENDER_EMAIL=your-email@yahoo.com")
        print("   SENDER_PASSWORD=your-app-password")
        return False
    else:
        print("โ ุงูุฅุนุฏุงุฏุงุช ุชุจุฏู ุตุญูุญุฉ")
        return True

def show_unified_setup_info():
    """ุนุฑุถ ูุนูููุงุช ุงูุฅุนุฏุงุฏ ุงูููุญุฏ"""
    print("๐ง ุฅุนุฏุงุฏ ููุญุฏ ููุจุฑูุฏ ุงูุฅููุชุฑููู")
    print("=" * 50)
    print()
    print("๐ฏ ูุฐุง ุงูุฅุนุฏุงุฏ ุณูุคุซุฑ ุนูู:")
    print("   โ ุฅุดุนุงุฑุงุช ุงูุทูุจุงุช (ูููุฏูุฑ)")
    print("   โ ุฑุณุงุฆู ุชุฃููุฏ ุงูุทูุจุงุช (ููุนููุงุก)")
    print("   โ ุฑุณุงุฆู ูููุฐุฌ 'ุงุชุตู ุจูุง'")
    print("   โ ุฌููุน ุงูุฅุดุนุงุฑุงุช ุงูุฃุฎุฑู")
    print()
    print("๐ฌ ุงูุจุฑูุฏ ุงููุณุชูุจู:")
    print("   - ุฅุดุนุงุฑุงุช ุงูุทูุจุงุช โ ููุณ ุงูุจุฑูุฏ ุงููุฑุณู")
    print("   - ุฑุณุงุฆู 'ุงุชุตู ุจูุง' โ ููุณ ุงูุจุฑูุฏ ุงููุฑุณู")
    print("   - ุฑุณุงุฆู ุชุฃููุฏ ุงูุนููุงุก โ ุจุฑูุฏ ุงูุนููู")
    print()

def setup_email_config():
    """ุฅุนุฏุงุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู"""
    print("\n๐ง ุฅุนุฏุงุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงูููุญุฏ...")
    print("=" * 50)
    
    # ุงุฎุชูุงุฑ ูุฒูุฏ ุงูุจุฑูุฏ
    print("\nุงุฎุชุฑ ูุฒูุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู:")
    print("1. Yahoo Mail (ููุตู ุจู)")
    print("2. Gmail")
    print("3. Outlook/Hotmail")
    
    while True:
        choice = input("\nุงุฎุชุฑ ุฑูู (1-3): ").strip()
        if choice in ['1', '2', '3']:
            break
        print("โ ุงุฎุชุฑ ุฑูู ุตุญูุญ (1-3)")
    
    providers = {
        '1': 'yahoo',
        '2': 'gmail', 
        '3': 'outlook'
    }
    
    provider = providers[choice]
    print(f"โ ุชู ุงุฎุชูุงุฑ: {provider.upper()}")
    
    # ุฅุฏุฎุงู ุจูุงูุงุช ุงูุจุฑูุฏ
    print(f"\n๐ ุฃุฏุฎู ุจูุงูุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ({provider.upper()}):")
    print("   ูุฐุง ุงูุจุฑูุฏ ุณูุณุชุฎุฏู ูุฌููุน ุงูุฅุดุนุงุฑุงุช")
    
    while True:
        email = input("ุงูุจุฑูุฏ ุงูุฅููุชุฑููู: ").strip()
        if '@' in email and '.' in email:
            break
        print("โ ุฃุฏุฎู ุจุฑูุฏ ุฅููุชุฑููู ุตุญูุญ")
    
    print(f"\n๐ ูููุฉ ูุฑูุฑ ุงูุชุทุจููุงุช:")
    print("   - ูู Yahoo: ุงุฐูุจ ุฅูู Account Security > App passwords")
    print("   - ูู Gmail: ุงุฐูุจ ุฅูู Security > App passwords")
    print("   - ูู Outlook: ุงุฐูุจ ุฅูู Security > App passwords")
    print("   โ๏ธ ุงุณุชุฎุฏู ูููุฉ ูุฑูุฑ ุงูุชุทุจููุงุช ูููุณ ูููุฉ ูุฑูุฑ ุงูุญุณุงุจ!")
    
    password = input("ูููุฉ ูุฑูุฑ ุงูุชุทุจููุงุช: ").strip()
    
    return {
        'provider': provider,
        'sender_email': email,
        'sender_password': password,
        'receiver_email': email  # ููุณ ุงูุจุฑูุฏ ูููุฑุณู ูุงููุณุชูุจู
    }

def update_env_file(config):
    """ุชุญุฏูุซ ููู .env"""
    print("\n๐พ ุชุญุฏูุซ ููู .env...")
    
    env_content = f"""# ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููููุน Velio Store
# ุชู ุฅุนุฏุงุฏูุง ุชููุงุฆูุงู ุจูุงุณุทุฉ fix_contact_form_unified.py
# ููุณ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุทูุจุงุช ููููุฐุฌ "ุงุชุตู ุจูุง"

# ููุน ูุฒูุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู (yahoo, gmail, outlook)
EMAIL_PROVIDER={config['provider']}

# ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูููุฑุณู (ูุฌููุน ุงูุฅุดุนุงุฑุงุช)
SENDER_EMAIL={config['sender_email']}
SENDER_PASSWORD={config['sender_password']}

# ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ูุงุณุชูุจุงู ุฑุณุงุฆู ุงูุชูุงุตู ูุงูุทูุจุงุช
# ููุณ ุงูุจุฑูุฏ ุงููุฑุณู (ุณูุณุชูุจู ุฌููุน ุงูุฅุดุนุงุฑุงุช)
RECEIVER_EMAIL={config['receiver_email']}

# ุฅุนุฏุงุฏุงุช SMTP (ุณูุชู ุชุนููููุง ุชููุงุฆูุงู ุญุณุจ EMAIL_PROVIDER)
# SMTP_SERVER=smtp.mail.yahoo.com
# SMTP_PORT=587

# ููุชุงุญ ุงูุฃูุงู ููุชุทุจูู
SECRET_KEY=velio-store-secret-key-2024

# ุฅุนุฏุงุฏุงุช ูุงุนุฏุฉ ุงูุจูุงูุงุช
DATABASE_URL=sqlite:///instance/products.db
"""
    
    with open('.env', 'w', encoding='utf-8') as f:
        f.write(env_content)
    
    print("โ ุชู ุชุญุฏูุซ ููู .env ุจูุฌุงุญ")

def test_email_config():
    """ุงุฎุชุจุงุฑ ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ"""
    print("\n๐งช ุงุฎุชุจุงุฑ ุฅุนุฏุงุฏุงุช ุงูุจุฑูุฏ...")
    
    try:
        # ุชุญููู ูุชุบูุฑุงุช ุงูุจูุฆุฉ
        from dotenv import load_dotenv
        load_dotenv()
        
        # ุงุณุชูุฑุงุฏ ุฏุงูุฉ ุงูุฅุฑุณุงู
        sys.path.append('web')
        from app import send_email
        
        # ุฅุฑุณุงู ุฑุณุงูุฉ ุงุฎุชุจุงุฑ
        subject = "๐งช ุงุฎุชุจุงุฑ ุงููุธุงู ุงูููุญุฏ - Velio Store"
        body = f"""ูุฐู ุฑุณุงูุฉ ุงุฎุชุจุงุฑ ูู ูุธุงู Velio Store ุงูููุญุฏ.

โ ุฅุฐุง ูุตูุชู ูุฐู ุงูุฑุณุงูุฉุ ูุงููุธุงู ูุนูู ุจุดูู ุตุญูุญ!

๐ฏ ูุฐุง ุงูุจุฑูุฏ ุณูุณุชูุจู:
- ๐ง ุฑุณุงุฆู ูููุฐุฌ "ุงุชุตู ุจูุง"
- ๐ ุฅุดุนุงุฑุงุช ุงูุทูุจุงุช ุงูุฌุฏูุฏุฉ
- ๐ ุฅุดุนุงุฑุงุช ุงูููุงูุน
- ๐ ุฌููุน ุงูุฅุดุนุงุฑุงุช ุงูุฃุฎุฑู

ุงูุชุงุฑูุฎ: {__import__('datetime').datetime.now().strftime('%Y-%m-%d %H:%M:%S')}

---
ูุฐู ุฑุณุงูุฉ ุชููุงุฆูุฉ ูู ูุธุงู ุงุฎุชุจุงุฑ Velio Store"""
        
        result = send_email(subject, body)
        
        if result:
            print("โ ุชู ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุงุฎุชุจุงุฑ ุจูุฌุงุญ!")
            print("๐ง ุชุญูู ูู ุตูุฏูู ุงููุงุฑุฏ (ูุงูุจุฑูุฏ ุงููููู)")
            return True
        else:
            print("โ ูุดู ูู ุฅุฑุณุงู ุฑุณุงูุฉ ุงูุงุฎุชุจุงุฑ")
            return False
            
    except Exception as e:
        print(f"โ ุฎุทุฃ ูู ุงูุงุฎุชุจุงุฑ: {e}")
        return False

def show_next_steps():
    """ุนุฑุถ ุงูุฎุทูุงุช ุงูุชุงููุฉ"""
    print("\n" + "=" * 70)
    print("๐ ุชู ุฅุนุฏุงุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ุงูููุญุฏ ุจูุฌุงุญ!")
    print("=" * 70)
    print()
    print("๐ ูุง ุชู ุฅุนุฏุงุฏู:")
    print("โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููุทูุจุงุช")
    print("โ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู ููููุฐุฌ 'ุงุชุตู ุจูุง'")
    print("โ ุฌููุน ุงูุฅุดุนุงุฑุงุช ุงูุฃุฎุฑู")
    print()
    print("๐ ุงูุฎุทูุงุช ุงูุชุงููุฉ:")
    print("1. โ ุชุญูู ูู ุตูุฏูู ุงููุงุฑุฏ ููุฑุณุงูุฉ ุงูุชุฌุฑูุจูุฉ")
    print("2. ๐ ุฃุนุฏ ุชุดุบูู ุงูุชุทุจูู:")
    print("   python3 web/app.py")
    print("3. ๐ ุงุฐูุจ ุฅูู ุตูุญุฉ 'ุงุชุตู ุจูุง' ูุงุฎุชุจุฑ ุงููููุฐุฌ")
    print("4. ๐ ุฌุฑุจ ุฅูุดุงุก ุทูุจ ูุงุฎุชุจุฑ ุงูุฅุดุนุงุฑุงุช")
    print("5. ๐ง ูุฌุจ ุฃู ุชุตูู ุฌููุน ุงูุฑุณุงุฆู")
    print()
    print("๐ง ุฅุฐุง ูู ุชุตู ุงูุฑุณุงุฆู:")
    print("- ุชุญูู ูู ูุฌูุฏ ุงูุจุฑูุฏ ุงููููู")
    print("- ุชุฃูุฏ ูู ุตุญุฉ ูููุฉ ูุฑูุฑ ุงูุชุทุจููุงุช")
    print("- ุฌุฑุจ ูุฒูุฏ ุจุฑูุฏ ุขุฎุฑ")
    print()
    print("๐ ููุฏุนู: ุชุญูู ูู ููู CONTACT_FORM_FIX_GUIDE.md")

def main():
    """ุงูุฏุงูุฉ ุงูุฑุฆูุณูุฉ"""
    print_header()
    
    # ุนุฑุถ ูุนูููุงุช ุงูุฅุนุฏุงุฏ ุงูููุญุฏ
    show_unified_setup_info()
    
    # ูุญุต ุงูุฅุนุฏุงุฏุงุช ุงูุญุงููุฉ
    if check_current_config():
        print("\nโ ุงูุฅุนุฏุงุฏุงุช ุชุจุฏู ุตุญูุญุฉ ุจุงููุนู!")
        choice = input("ูู ุชุฑูุฏ ุฅุนุงุฏุฉ ุงูุฅุนุฏุงุฏุ (y/n): ").strip().lower()
        if choice != 'y':
            print("๐ ุชู ุงูุฅูุบุงุก")
            return
    
    try:
        # ุฅุนุฏุงุฏ ุงูุจุฑูุฏ ุงูุฅููุชุฑููู
        config = setup_email_config()
        
        # ุชุญุฏูุซ ููู .env
        update_env_file(config)
        
        # ุงุฎุชุจุงุฑ ุงูุฅุนุฏุงุฏุงุช
        if test_email_config():
            show_next_steps()
        else:
            print("\nโ๏ธ ูุดู ุงูุงุฎุชุจุงุฑุ ููู ุงูุฅุนุฏุงุฏุงุช ุชู ุญูุธูุง")
            print("๐ง ููููู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุจุช ุฃู ุงูุชุญูู ูู ุงูุฅุนุฏุงุฏุงุช ูุฏููุงู")
            
    except KeyboardInterrupt:
        print("\n\n๐ ุชู ุงูุฅูุบุงุก ุจูุงุณุทุฉ ุงููุณุชุฎุฏู")
    except Exception as e:
        print(f"\nโ ุญุฏุซ ุฎุทุฃ: {e}")
        print("๐ง ููููู ุฅุนุงุฏุฉ ุชุดุบูู ุงูุณูุฑูุจุช ุฃู ุงูุฅุนุฏุงุฏ ูุฏููุงู")

if __name__ == "__main__":
    main()
